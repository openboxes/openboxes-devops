# Requires `ansible-galaxy collection install ansible.posix`

- name: Enabling bamboo remote restart
  hosts: all
  tasks:

    - name: Adding bamboo user
      ansible.builtin.user:
        create_home: true
        group: "{{ item.group }}"
        groups: "{{ item.groups }}"
        name: "{{ item.name }}"
        password: '!'
        system: "{{ item.system | bool }}"
        uid: "{{ item.uid }}"
      loop:
        - group: staff
          groups: tomcat
          name: bamboo
          system: false
          uid: 1509

    - name: Adding authorized public keys for bamboo user
      when: 'lookup("ansible.builtin.fileglob", item.key_file) != []'
      ansible.posix.authorized_key:
        key: "{{ lookup('ansible.builtin.file', item.key_file) }}"
        state: present
        user: "{{ item.user }}"
      loop:
        - key_file: ../public_keys/bamboo_ed25519.pub
          user: bamboo

    - name: Enabling limited sudo access for bamboo
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "{{ item.line }}"
        regexp: "{{ item.regexp }}"
        validate: visudo -cf %s
      loop:
        - line: 'bamboo ALL=(ALL) NOPASSWD:/sbin/service,/usr/sbin/service'
          regexp: '^bamboo'

    - name: Adding restart-tomcat script for Bamboo
      when: webserver is defined
      ansible.builtin.template:
        dest: /opt/restart-tomcat.sh
        group: staff
        mode: '0550'
        owner: bamboo
        src: ../templates/restart-tomcat.sh.j2

    #
    # The following task ignores Tomcat best practices, but bamboo needs it to work.
    #
    # > It is recommended to never grant the manager-script or
    # > manager-jmx roles to users that have the manager-gui role.
    #
    # https://tomcat.apache.org/tomcat-8.5-doc/manager-howto.html#Configuring_Manager_Application_Access
    #
    - name: Injecting Tomcat user for bamboo
      ansible.builtin.lineinfile:
        insertbefore: '^</tomcat-users>'
        # https://confluence.atlassian.com/bamboo/using-tomcat-with-bamboo-for-continuous-deployment-305759758.html
        line: '  <user username="bamboo" password="{{ tomcat_users.bamboo.password }}" roles="manager-gui,manager-script" /> <!-- ANSIBLE MANAGED -->'
        path: "/var/lib/{{ item }}/conf/tomcat-users.xml"
        regexp: 'username="bamboo"'
      loop:
        - tomcat7
        - tomcat85

    - name: Restarting Tomcat service on web-serving hosts
      when: webserver is defined
      ansible.builtin.systemd:
        daemon_reload: true
        enabled: true
        name: tomcat
        state: restarted
